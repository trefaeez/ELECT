# توثيق نظام إدارة شبكات الطاقة الكهربائية

## مقدمة

هذا المستند يوثق نظام إدارة شبكات الطاقة الكهربائية، مع التركيز على التحديثات والميزات الجديدة التي تم إضافتها للدعم:

1. الهيكلية الشجرية للوحات الكهربائية
2. العلاقات المتعددة بين القواطع الكهربائية
3. الربط المرن بين اللوحات والقواطع

## هيكلية النظام المحدثة

### 1. مصادر الطاقة (PowerSource)

مصادر الطاقة هي نقطة البداية في النظام وتمثل المصادر الرئيسية للكهرباء مثل:
- الشبكة المحلية
- المولدات الكهربائية

**التحديثات الجديدة:**
- تحسين العلاقة مع القاطع الرئيسي
- واجهة برمجية محسنة لإدارة مصادر الطاقة واللوحات المتصلة بها

### 2. اللوحات الكهربائية (Panel)

تمثل اللوحات الكهربائية نقاط توزيع الكهرباء في النظام. تم تحديث نموذج اللوحات ليدعم ثلاثة أنواع:

1. **لوحة رئيسية (main)**: متصلة مباشرة بمصدر طاقة ويمكن أن تحتوي على لوحات فرعية.
2. **لوحة رئيسية فرعية (sub_main)**: لوحة فرعية متصلة بلوحة أخرى ولكنها تحتوي أيضاً على لوحات فرعية.
3. **لوحة فرعية (sub)**: لوحة فرعية نهائية لا تحتوي على لوحات فرعية أخرى.

**الميزات الجديدة:**
- **هيكلية شجرية**: يمكن للوحات أن تحتوي على لوحات فرعية، ويمكن للوحات الفرعية أن تحتوي على لوحات فرعية أخرى.
- **حقل `parent_panel`**: يربط اللوحة الفرعية باللوحة الأم.
- **وظائف استعلام متقدمة**: للحصول على المسار الكامل والأحمال الكلية.
- **حماية من الدورات**: منع إنشاء دورات في هيكل اللوحات (لا يمكن للوحة أن تكون أماً لنفسها أو لإحدى اللوحات التي تعلوها).

### 3. القواطع الكهربائية (CircuitBreaker)

تمثل القواطع الكهربائية نقاط الحماية وتبديل الكهرباء في النظام.

**التحديثات الرئيسية:**
- **أدوار جديدة للقواطع**: تم إضافة دور "رئيسي فرعي" (sub_main) إلى جانب الأدوار السابقة "رئيسي" و"توزيع".
- **العلاقات المتعددة**: يمكن لقاطع الآن أن يتغذى من عدة قواطع أخرى من خلال علاقة many-to-many.
- **حماية من الدورات**: منع إنشاء دورات في علاقات التغذية بين القواطع.
- **تتبع المسار الكامل**: إمكانية تتبع مسار التغذية الكامل من خلال سلسلة القواطع.

### 4. الأحمال الكهربائية (Load)

تمثل الأحمال المستهلكات النهائية للكهرباء في النظام.

**التحسينات:**
- تحسين آلية ربط الأحمال بالقواطع واللوحات
- إضافة وظائف حساب متقدمة للاستهلاك وهبوط الجهد

## العلاقات الرئيسية في النظام

### علاقة مصدر الطاقة بالمكونات الأخرى

```
PowerSource 1:n Panel (main)
PowerSource 1:1 CircuitBreaker (main_breaker)
```

### العلاقات الشجرية للوحات

```
Panel (parent) 1:n Panel (child)
```

- لوحة رئيسية يمكن أن تحتوي على عدة لوحات فرعية (رئيسية فرعية أو فرعية).
- لوحة رئيسية فرعية يمكن أن تحتوي على عدة لوحات فرعية أخرى.
- لوحة فرعية لا يمكن أن تحتوي على لوحات فرعية أخرى.

### العلاقات المرنة للقواطع

```
CircuitBreaker n:m CircuitBreaker (feeding_breakers -> fed_breakers)
Panel 1:n CircuitBreaker
Panel 1:1 CircuitBreaker (main_breaker)
Panel 1:1 CircuitBreaker (feeder_breaker)
```

- قاطع يمكن أن يتغذى من عدة قواطع.
- قاطع يمكن أن يغذي عدة قواطع.
- لوحة يمكن أن تحتوي على عدة قواطع.
- لوحة لها قاطع رئيسي واحد.
- لوحة فرعية لها قاطع مغذي واحد من اللوحة الأم.

### علاقة الأحمال بالمكونات الأخرى

```
Panel 1:n Load
CircuitBreaker 1:n Load
```

- لوحة يمكن أن تحتوي على عدة أحمال.
- قاطع يمكن أن يغذي عدة أحمال.

## واجهة برمجة التطبيقات (API)

تم تحديث واجهة برمجة التطبيقات (API) لدعم جميع العمليات الجديدة:

### مصادر الطاقة (PowerSource)

- `GET /api/powersources/` - قائمة جميع مصادر الطاقة
- `POST /api/powersources/` - إضافة مصدر طاقة جديد
- `GET /api/powersources/{id}/` - عرض تفاصيل مصدر طاقة
- `PUT /api/powersources/{id}/` - تحديث مصدر طاقة
- `DELETE /api/powersources/{id}/` - حذف مصدر طاقة
- `GET /api/powersources/{id}/panels/` - عرض اللوحات المتصلة بمصدر طاقة
- `POST /api/powersources/{id}/panels/` - إضافة لوحة جديدة لمصدر طاقة
- `POST /api/powersources/{id}/set_main_breaker/` - تعيين القاطع الرئيسي لمصدر الطاقة

### اللوحات الكهربائية (Panel)

- `GET /api/panels/` - قائمة جميع اللوحات
- `POST /api/panels/` - إضافة لوحة جديدة
- `GET /api/panels/{id}/` - عرض تفاصيل لوحة
- `PUT /api/panels/{id}/` - تحديث لوحة
- `DELETE /api/panels/{id}/` - حذف لوحة
- `GET /api/panels/{id}/breakers/` - عرض القواطع في لوحة
- `POST /api/panels/{id}/breakers/` - إضافة قاطع جديد للوحة
- `GET /api/panels/{id}/child_panels/` - عرض اللوحات الفرعية المباشرة
- `POST /api/panels/{id}/child_panels/` - إضافة لوحة فرعية جديدة
- `GET /api/panels/{id}/all_child_panels/` - عرض جميع اللوحات الفرعية (المباشرة وغير المباشرة)
- `POST /api/panels/{id}/set_main_breaker/` - تعيين القاطع الرئيسي للوحة
- `POST /api/panels/{id}/set_feeder_breaker/` - تعيين القاطع المغذي للوحة في اللوحة الأم

### القواطع الكهربائية (CircuitBreaker)

- `GET /api/circuitbreakers/` - قائمة جميع القواطع
- `POST /api/circuitbreakers/` - إضافة قاطع جديد
- `GET /api/circuitbreakers/{id}/` - عرض تفاصيل قاطع
- `PUT /api/circuitbreakers/{id}/` - تحديث قاطع
- `DELETE /api/circuitbreakers/{id}/` - حذف قاطع
- `GET /api/circuitbreakers/{id}/loads/` - عرض الأحمال المتصلة بقاطع
- `POST /api/circuitbreakers/{id}/loads/` - إضافة حمل جديد للقاطع
- `GET /api/circuitbreakers/{id}/feeding_breakers/` - عرض القواطع التي تغذي هذا القاطع
- `PUT /api/circuitbreakers/{id}/feeding_breakers/` - تحديث قائمة القواطع المغذية
- `GET /api/circuitbreakers/{id}/fed_breakers/` - عرض القواطع التي يغذيها هذا القاطع
- `GET /api/circuitbreakers/by_panel/?panel_id={id}` - تصفية القواطع حسب اللوحة
- `GET /api/circuitbreakers/by_role/?role={role}` - تصفية القواطع حسب الدور
- `GET /api/circuitbreakers/{id}/full_path/` - عرض المسار الكامل للقاطع
- `GET /api/circuitbreakers/{id}/total_load/` - حساب إجمالي الحمل على القاطع

### الأحمال الكهربائية (Load)

- `GET /api/loads/` - قائمة جميع الأحمال
- `POST /api/loads/` - إضافة حمل جديد
- `GET /api/loads/{id}/` - عرض تفاصيل حمل
- `PUT /api/loads/{id}/` - تحديث حمل
- `DELETE /api/loads/{id}/` - حذف حمل
- `GET /api/loads/by_panel/?panel_id={id}` - تصفية الأحمال حسب اللوحة
- `GET /api/loads/by_breaker/?breaker_id={id}` - تصفية الأحمال حسب القاطع
- `GET /api/loads/by_type/?load_type={type}` - تصفية الأحمال حسب النوع

## أمثلة الاستخدام

### إنشاء هيكل شجري للوحات

1. إنشاء مصدر طاقة:
```json
POST /api/powersources/
{
    "name": "المصدر الرئيسي",
    "source_type": "Local Grid",
    "voltage": "380",
    "total_ampacity": 250
}
```

2. إنشاء قاطع رئيسي لمصدر الطاقة:
```json
POST /api/circuitbreakers/
{
    "name": "القاطع الرئيسي للمصدر",
    "breaker_type": "MCCB",
    "breaker_role": "main",
    "rated_current": 250,
    "number_of_poles": 4
}
```

3. تعيين القاطع الرئيسي لمصدر الطاقة:
```json
POST /api/powersources/1/set_main_breaker/
{
    "breaker_id": 1
}
```

4. إنشاء لوحة رئيسية متصلة بمصدر الطاقة:
```json
POST /api/powersources/1/panels/
{
    "name": "اللوحة الرئيسية",
    "panel_type": "main",
    "ampacity": 200
}
```

5. إنشاء قاطع رئيسي للوحة:
```json
POST /api/panels/1/breakers/
{
    "name": "القاطع الرئيسي للوحة",
    "breaker_type": "MCCB",
    "breaker_role": "main",
    "rated_current": 200,
    "number_of_poles": 4
}
```

6. إنشاء قاطع توزيع في اللوحة الرئيسية (لتغذية لوحة فرعية):
```json
POST /api/panels/1/breakers/
{
    "name": "قاطع تغذية اللوحة الفرعية",
    "breaker_type": "MCB",
    "breaker_role": "distribution",
    "rated_current": 63,
    "number_of_poles": 3
}
```

7. إنشاء لوحة فرعية متصلة باللوحة الرئيسية:
```json
POST /api/panels/1/child_panels/
{
    "name": "لوحة فرعية",
    "panel_type": "sub_main",
    "ampacity": 63,
    "feeder_breaker_id": 3
}
```

### ربط القواطع ببعضها (تغذية متعددة)

1. إنشاء قاطع في لوحة فرعية:
```json
POST /api/panels/2/breakers/
{
    "name": "قاطع توزيع",
    "breaker_type": "MCB",
    "breaker_role": "distribution",
    "rated_current": 32,
    "number_of_poles": 2
}
```

2. ربط القاطع بمصادر تغذية متعددة:
```json
PUT /api/circuitbreakers/4/feeding_breakers/
{
    "feeding_breakers": [3, 2]
}
```

## ملاحظات هامة

1. **تحقق الاتساق**: النظام يقوم بالتحقق من اتساق البيانات ويمنع الحالات غير المنطقية، مثل:
   - لوحة رئيسية متصلة بلوحة أم
   - لوحة فرعية متصلة بمصدر طاقة مباشرة
   - دورات في هيكل اللوحات
   - دورات في علاقات التغذية بين القواطع

2. **الأنواع الإضافية**: يمكن توسيع النظام بسهولة لدعم أنواع إضافية من مصادر الطاقة واللوحات والقواطع والأحمال.

3. **حساب الأحمال**: النظام يدعم حساب إجمالي الأحمال على القواطع واللوحات، مما يساعد في تحليل توزيع الأحمال.

4. **توثيق API**: يمكن الوصول إلى توثيق واجهة برمجة التطبيقات من خلال صفحة Swagger/OpenAPI المدمجة في النظام.

## الخاتمة

تقدم النسخة المحدثة من نظام إدارة شبكات الطاقة الكهربائية مرونة كبيرة في تمثيل هياكل اللوحات المعقدة وربط القواطع بطرق متعددة. هذه المرونة تسمح بتمثيل شبكات كهربائية واقعية ومعقدة مع الحفاظ على سلامة البيانات واتساقها.