# معمارية نظام إدارة شبكة الطاقة الكهربائية

## نظرة عامة

نظام إدارة شبكة الطاقة الكهربائية هو تطبيق ويب متكامل يهدف إلى تسهيل تصميم وإدارة ومراقبة شبكات التوزيع الكهربائية. يوفر النظام واجهة مستخدم رسومية سهلة الاستخدام مع واجهة برمجة تطبيقات (API) قوية لإدارة مكونات الشبكة الكهربائية المختلفة.

## الهيكل العام للنظام

النظام مبني باستخدام Django و Django REST Framework ويتبع نمط هندسي يفصل بين الطبقات المختلفة:

```
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│   واجهة       │      │  وحدات        │      │  طبقة        │
│  المستخدم     │◄────►│ التحكم (API)  │◄────►│  البيانات    │
└───────────────┘      └───────────────┘      └───────────────┘
```

## المكونات الرئيسية

### 1. الكيانات الأساسية للنظام

النظام يتكون من أربعة كيانات رئيسية:

1. **مصادر الطاقة (PowerSource)**: تمثل مصادر الطاقة الرئيسية مثل الشبكة المحلية أو المولدات.
2. **اللوحات الكهربائية (Panel)**: تمثل اللوحات الكهربائية (رئيسية وفرعية) وتدعم الهيكلية الشجرية.
3. **قواطع الدارة الكهربائية (CircuitBreaker)**: تمثل القواطع الكهربائية بأنواعها المختلفة.
4. **الأحمال الكهربائية (Load)**: تمثل الأحمال المختلفة المتصلة بالشبكة.

### 2. العلاقات بين الكيانات

```
┌───────────────┐      ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│  مصدر الطاقة  │──1:N─►│ لوحة رئيسية  │──1:N─►│     قاطع     │──1:N─►│     حمل      │
└───────────────┘      └───────────────┘      └───────────────┘      └───────────────┘
                            │                      ▲
                            │                      │
                            │                      │
                            └─────►──────1:N───────┘
                            لوحة فرعية
```

- **مصدر الطاقة** يغذي **لوحة رئيسية** واحدة أو أكثر
- **اللوحة الرئيسية** تحتوي على **قواطع** متعددة وقد تغذي **لوحات فرعية**
- **اللوحة الفرعية** يمكن أن تحتوي على **لوحات فرعية** أخرى (هيكل شجري)
- **القاطع** يمكن أن يغذي **أحمال** متعددة أو **لوحات فرعية**
- **القاطع** يمكن أن يتغذى من **قواطع** أخرى (علاقة عديد لعديد)

### 3. المخططات التفاعلية

يوفر النظام نوعين من المخططات التفاعلية لعرض الشبكة الكهربائية:

1. **مخطط اللوحات الشجري (Panel Tree)**: يعرض هيكل اللوحات بشكل شجري مع إمكانية الطي والتوسعة.
2. **مخطط الشبكة التفاعلي (Network Visualizer)**: يعرض الشبكة الكهربائية كاملة مع جميع العناصر والروابط بينها:
   - إظهار/إخفاء العناصر حسب النوع
   - القواطع مخفية افتراضياً وتظهر عند النقر على اللوحة
   - إضاءة مسارات التغذية والأحمال
   - جداول ديناميكية للمسارات المختارة

للتفاصيل الكاملة عن المخطط التفاعلي، راجع [توثيق المخطط التفاعلي](./NETWORK_VISUALIZER.md).

## هيكل الشيفرة

### 1. نماذج البيانات (models.py)

يحتوي على تعريفات الكيانات الرئيسية وعلاقاتها:

- `PowerSource`: نموذج مصادر الطاقة
- `Panel`: نموذج اللوحات الكهربائية مع دعم الهيكلية الشجرية
- `CircuitBreaker`: نموذج القواطع الكهربائية مع دعم تعدد المغذيات
- `Load`: نموذج الأحمال الكهربائية
- `CableMixin`: ميكسن للخصائص المشتركة للكابلات
- `CableConstants`: فئة مساعدة لتخزين بيانات مقاطع الكابلات والمعاملات المشتركة

### 2. المحولات (serializers.py)

يحتوي على محولات البيانات لتحويل نماذج قاعدة البيانات إلى بيانات JSON والعكس:

- `PowerSourceSerializer`: محول لمصادر الطاقة
- `PanelSerializer`: محول للوحات الكهربائية
- `CircuitBreakerSerializer`: محول للقواطع الكهربائية
- `LoadSerializer`: محول للأحمال الكهربائية
- محولات إضافية متخصصة للعلاقات المعقدة

### 3. وحدات التحكم (views.py)

يحتوي على وحدات التحكم التي تتعامل مع طلبات API:

- `PowerSourceViewSet`: وحدة تحكم لمصادر الطاقة
- `PanelViewSet`: وحدة تحكم للوحات الكهربائية
- `CircuitBreakerViewSet`: وحدة تحكم للقواطع الكهربائية
- `LoadViewSet`: وحدة تحكم للأحمال الكهربائية
- دوال عرض إضافية للصفحات HTML والمخططات التفاعلية

### 4. المسارات (urls.py)

يحتوي على تعريفات مسارات API والصفحات:

- مسارات API لـ CRUD العمليات الأساسية
- مسارات مخصصة للعمليات المتقدمة
- مسارات للصفحات HTML والمخططات التفاعلية

## واجهة برمجة التطبيقات (API)

### 1. نقاط نهاية مصادر الطاقة

| العملية | طريقة HTTP | نقطة النهاية | الوصف |
|---------|------------|--------------|-------|
| الحصول على جميع مصادر الطاقة | GET | `/api/powersources/` | يسترجع قائمة بجميع مصادر الطاقة |
| الحصول على مصدر طاقة محدد | GET | `/api/powersources/{id}/` | يسترجع تفاصيل مصدر طاقة محدد |
| إنشاء مصدر طاقة جديد | POST | `/api/powersources/` | إضافة مصدر طاقة جديد |
| تحديث مصدر طاقة | PUT/PATCH | `/api/powersources/{id}/` | تحديث معلومات مصدر طاقة |
| حذف مصدر طاقة | DELETE | `/api/powersources/{id}/` | حذف مصدر طاقة محدد |
| اللوحات المرتبطة | GET | `/api/powersources/{id}/panels/` | استرجاع اللوحات المرتبطة |
| إضافة لوحة جديدة | POST | `/api/powersources/{id}/panels/` | إضافة لوحة رئيسية جديدة |
| تعيين القاطع الرئيسي | POST | `/api/powersources/{id}/set_main_breaker/` | تعيين قاطع رئيسي |

### 2. نقاط نهاية اللوحات الكهربائية

| العملية | طريقة HTTP | نقطة النهاية | الوصف |
|---------|------------|--------------|-------|
| الحصول على جميع اللوحات | GET | `/api/panels/` | يسترجع قائمة بجميع اللوحات |
| الحصول على لوحة محددة | GET | `/api/panels/{id}/` | يسترجع تفاصيل لوحة محددة |
| إنشاء لوحة جديدة | POST | `/api/panels/` | إضافة لوحة جديدة |
| تحديث لوحة | PUT/PATCH | `/api/panels/{id}/` | تحديث معلومات لوحة |
| حذف لوحة | DELETE | `/api/panels/{id}/` | حذف لوحة محددة |
| قواطع اللوحة | GET | `/api/panels/{id}/breakers/` | استرجاع قواطع اللوحة |
| إضافة قاطع جديد | POST | `/api/panels/{id}/breakers/` | إضافة قاطع جديد |
| اللوحات الفرعية | GET | `/api/panels/{id}/child_panels/` | استرجاع اللوحات الفرعية المباشرة |
| إضافة لوحة فرعية | POST | `/api/panels/{id}/child_panels/` | إضافة لوحة فرعية جديدة |
| جميع اللوحات الفرعية | GET | `/api/panels/{id}/all_child_panels/` | استرجاع جميع اللوحات الفرعية |
| تعيين القاطع الرئيسي | POST | `/api/panels/{id}/set_main_breaker/` | تعيين قاطع رئيسي |
| تعيين القاطع المغذي | POST | `/api/panels/{id}/set_feeder_breaker/` | تعيين القاطع المغذي |

### 3. نقاط نهاية قواطع الدارة الكهربائية

| العملية | طريقة HTTP | نقطة النهاية | الوصف |
|---------|------------|--------------|-------|
| الحصول على جميع القواطع | GET | `/api/circuitbreakers/` | يسترجع قائمة بجميع القواطع |
| الحصول على قاطع محدد | GET | `/api/circuitbreakers/{id}/` | يسترجع تفاصيل قاطع محدد |
| إنشاء قاطع جديد | POST | `/api/circuitbreakers/` | إضافة قاطع جديد |
| تحديث قاطع | PUT/PATCH | `/api/circuitbreakers/{id}/` | تحديث معلومات قاطع |
| حذف قاطع | DELETE | `/api/circuitbreakers/{id}/` | حذف قاطع محدد |
| أحمال القاطع | GET | `/api/circuitbreakers/{id}/loads/` | استرجاع أحمال القاطع |
| إضافة حمل جديد | POST | `/api/circuitbreakers/{id}/loads/` | إضافة حمل جديد |
| القواطع المغذية | GET | `/api/circuitbreakers/{id}/feeding_breakers/` | استرجاع القواطع المغذية |
| تحديث القواطع المغذية | PUT | `/api/circuitbreakers/{id}/feeding_breakers/` | تحديث القواطع المغذية |
| القواطع المغذاة | GET | `/api/circuitbreakers/{id}/fed_breakers/` | استرجاع القواطع المغذاة |
| تصفية حسب اللوحة | GET | `/api/circuitbreakers/by_panel/?panel_id={id}` | تصفية حسب اللوحة |
| تصفية حسب الدور | GET | `/api/circuitbreakers/by_role/?role={role}` | تصفية حسب الدور |
| المسار الكامل | GET | `/api/circuitbreakers/{id}/full_path/` | استرجاع المسار الكامل |
| إجمالي الحمل | GET | `/api/circuitbreakers/{id}/total_load/` | حساب إجمالي الحمل |

### 4. نقاط نهاية الأحمال الكهربائية

| العملية | طريقة HTTP | نقطة النهاية | الوصف |
|---------|------------|--------------|-------|
| الحصول على جميع الأحمال | GET | `/api/loads/` | يسترجع قائمة بجميع الأحمال |
| الحصول على حمل محدد | GET | `/api/loads/{id}/` | يسترجع تفاصيل حمل محدد |
| إنشاء حمل جديد | POST | `/api/loads/` | إضافة حمل جديد |
| تحديث حمل | PUT/PATCH | `/api/loads/{id}/` | تحديث معلومات حمل |
| حذف حمل | DELETE | `/api/loads/{id}/` | حذف حمل محدد |
| تصفية حسب اللوحة | GET | `/api/loads/by_panel/?panel_id={id}` | استرجاع أحمال لوحة محددة |
| تصفية حسب القاطع | GET | `/api/loads/by_breaker/?breaker_id={id}` | استرجاع أحمال قاطع محدد |
| تصفية حسب النوع | GET | `/api/loads/by_type/?load_type={type}` | استرجاع أحمال من نوع محدد |

## واجهة المستخدم

النظام يوفر واجهة مستخدم مكونة من عدة صفحات HTML:

1. **الصفحة الرئيسية** (`index.html`): عرض لوحة تحكم رئيسية للنظام
2. **مصادر الطاقة** (`power-sources.html`): إدارة مصادر الطاقة
3. **اللوحات الكهربائية** (`panels.html`): إدارة اللوحات الكهربائية
4. **القواطع الكهربائية** (`breakers.html`): إدارة القواطع
5. **الأحمال الكهربائية** (`loads.html`): إدارة الأحمال

تستخدم واجهة المستخدم JavaScript لاستدعاء واجهة برمجة التطبيقات، مع ملفات في المجلدات التالية:
- `/static/js/app.js`: الشيفرة الرئيسية للواجهة
- `/static/js/api_endpoints.js`: تعريفات نقاط نهاية API
- `/static/js/modules/`: وحدات JavaScript المختلفة لكل كيان

## آليات حماية البيانات وضمان اتساقها

النظام يوفر العديد من الآليات لضمان اتساق البيانات:

1. **التحقق من العلاقات الدائرية**: منع تكوين دورات في الهيكل الشجري للوحات
2. **التحقق من اتساق العلاقات**: ضمان ارتباط القواطع والأحمال بالكيانات الصحيحة
3. **الحسابات التلقائية**: حساب تلقائي للقيم مثل هبوط الجهد وفقد الطاقة
4. **التحقق من قيود النماذج**: ضمان أن جميع القيم ضمن النطاقات المسموح بها

## المخططات البيانية والحسابات

النظام يدعم العديد من الحسابات الكهربائية:

1. **حساب الأحمال الكلية**: حساب إجمالي الحمل على كل قاطع ولوحة
2. **حساب هبوط الجهد**: حساب هبوط الجهد في الكابلات
3. **حساب فقد الطاقة**: حساب الفقد في الطاقة بسبب مقاومة الكابلات
4. **حساب السعة القصوى للكابلات**: تقدير السعة القصوى للتيار بناءً على نوع الكابل ومساره

## توسيعات مستقبلية

1. **تحسينات واجهة المستخدم**: إضافة رسومات تفاعلية لتمثيل الشبكة الكهربائية
2. **تحسينات أمنية**: تعزيز أمان الواجهة البرمجية بإضافة OAuth2
3. **تصدير تقارير**: إضافة إمكانية تصدير البيانات بتنسيقات مختلفة (PDF، Excel)
4. **وحدة محاكاة**: إضافة إمكانية محاكاة الشبكة للتنبؤ بتأثير التغييرات قبل تطبيقها
5. **تكامل مع أنظمة SCADA**: توفير إمكانية التكامل مع أنظمة الإشراف والتحكم
6. **واجهة تحليلات**: إضافة واجهة تحليلات متقدمة لتحليل أداء الشبكة الكهربائية

## المتطلبات التقنية

- Python 3.10+
- Django 4.0+
- Django REST Framework 3.13+
- SQLite (للتطوير)، PostgreSQL (للإنتاج)
- HTML5، CSS3، JavaScript (ES6+)

## تصميم قاعدة البيانات

قاعدة البيانات تتبع نفس هيكل النماذج المذكورة سابقًا، مع الجداول الرئيسية:

- `network_powersource`: جدول مصادر الطاقة
- `network_panel`: جدول اللوحات الكهربائية
- `network_circuitbreaker`: جدول القواطع الكهربائية
- `network_load`: جدول الأحمال الكهربائية
- `network_circuitbreaker_feeding_breakers`: جدول العلاقات بين القواطع